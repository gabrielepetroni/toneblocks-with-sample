<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Thesis</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <!-- <link rel='stylesheet' type='text/css' media='screen' href='style.css'> -->

    <!-- include core Blockly script and blocks -->
    <script src="google-blockly-ba6dfd8/blockly_compressed.js"></script>
    <script src="google-blockly-ba6dfd8/javascript_compressed.js"></script>
    <script src="google-blockly-ba6dfd8/blocks_compressed.js"></script>
    <script src="google-blockly-ba6dfd8/msg/js/en.js"></script>
    <script src="tone-13.8.2/Tone.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <h1>THESIS</h1>
    <div id="interface">

        <!-- Global Controls -->
        <div id="transport">
            <h2>Transport</h2>
            <div id="controls">
                <div id="tempoControl">
                    <div id="tempoDisplay">
                        <label for="tempoSlider">Tempo</label>
                        <input type="number" id="tempoNumber" name="tempoNumber" readonly="true">
                    </div>
                    <input type="range" id="tempoSlider" name="tempoSlider" min="60" max="260" value="120">
                </div>
                <button id="runbutton">Run Script</button>
            </div>
        </div>
        <div id="canvas">
            <!-- empty div for Blockly injection -->
            <div id="blocklyDiv" style="height: 500px; width: 600px"></div>

            <!-- toolbox -->
            <xml id="toolbox" style="display: none">
                <block type="controls_if"></block>
                <block type="controls_repeat_ext"></block>
                <block type="logic_compare"></block>
                <block type="math_number"></block>
                <block type="math_arithmetic"></block>
                <block type="text"></block>
                <block type="text_print"></block>
            </xml>

            <div id="textarea"></div>
        </div>
    </div>
    <script>
        // inject Blockly into the blocklyDiv
        const workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox')
        });

        // update textarea function
        function updateTextArea(event) {
            // convert workspace to text code
            let code = Blockly.JavaScript.workspaceToCode(workspace);
            //update textarea div with text code
            document.getElementById('textarea').innerText = code;
        }
        // add change listener to textarea, call update function
        workspace.addChangeListener(updateTextArea);

        // Generate JavaScript code and run it
        function runCode() {

            // prevent infinite loop
            window.LoopTrap = 1000;
            Blockly.JavaScript.INFINITE_LOOP_TRAP =
                'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';

            // convert workspace to text code
            let code = Blockly.JavaScript.workspaceToCode(workspace);

            Blockly.JavaScript.INFINITE_LOOP_TRAP = null;

            // test adding Tone synth trigger
            code = code + "synth.triggerAttackRelease('C4', '8n')";
            // evaluate code
            try {
                eval(code);
            } catch (e) {
                alert(e);
            }
        }

        // setup run button and add on-click listener
        const runButton = document.getElementById('runbutton');
        runButton.addEventListener('click', runCode);

        // setup hello-tone
        //create a synth and connect it to the master output (your speakers)
        let synth = new Tone.Synth().toMaster()

        //play a middle 'C' for the duration of an 8th note
    </script>
</body>

</html>